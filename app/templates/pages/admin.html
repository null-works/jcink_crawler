{% extends "base.html" %}
{% block title %}Admin - The Watcher{% endblock %}
{% block content %}
<div class="page-header">
    <h1>Admin</h1>
    <p class="subtitle">Service status and management</p>
</div>

{# Stats #}
<section class="stats-grid" id="admin-stats"
         hx-get="/htmx/stats" hx-trigger="every 30s" hx-swap="innerHTML">
    {% include "partials/stats_values.html" %}
</section>

{# Admin actions #}
<div class="admin-grid">
    {# Register character #}
    <div class="card">
        <h3 class="card-title">Register Character</h3>
        <p class="text-comment" style="font-size: 0.85rem; margin-bottom: 0.75rem;">
            Register a JCink user ID for tracking. Profile and threads will be crawled automatically.
        </p>
        <form hx-post="/htmx/register" hx-target="#register-result" hx-swap="innerHTML">
            <input type="text" name="user_id" class="form-input" placeholder="JCink User ID" required>
            <button type="submit" class="btn btn-purple">Register</button>
        </form>
        <div id="register-result" class="result"></div>
    </div>

    {# Crawl triggers #}
    <div class="card">
        <h3 class="card-title">Trigger Crawl</h3>
        <p class="text-comment" style="font-size: 0.85rem; margin-bottom: 0.75rem;">
            Manually trigger a crawl operation.
        </p>
        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
            <button class="btn btn-green"
                    hx-post="/htmx/crawl"
                    hx-vals='{"crawl_type": "discover"}'
                    hx-target="#crawl-result"
                    hx-swap="innerHTML">Discover Characters</button>
            <button class="btn btn-purple"
                    hx-post="/htmx/crawl"
                    hx-vals='{"crawl_type": "all-threads"}'
                    hx-target="#crawl-result"
                    hx-swap="innerHTML">Crawl All Threads</button>
            <button class="btn btn-ghost"
                    hx-post="/htmx/crawl"
                    hx-vals='{"crawl_type": "all-profiles"}'
                    hx-target="#crawl-result"
                    hx-swap="innerHTML">Crawl All Profiles</button>
        </div>
        <div id="crawl-result" class="result"></div>
    </div>

    {# Per-character crawl #}
    <div class="card">
        <h3 class="card-title">Crawl Specific Character</h3>
        <p class="text-comment" style="font-size: 0.85rem; margin-bottom: 0.75rem;">
            Trigger a crawl for a specific character.
        </p>
        <form hx-post="/htmx/crawl" hx-target="#char-crawl-result" hx-swap="innerHTML">
            <select name="character_id" class="form-input" required>
                <option value="">Select character...</option>
                {% for c in characters %}
                <option value="{{ c.id }}">{{ c.name }} (#{{ c.id }})</option>
                {% endfor %}
            </select>
            <select name="crawl_type" class="form-input">
                <option value="threads">Threads</option>
                <option value="profile">Profile</option>
            </select>
            <button type="submit" class="btn btn-purple">Crawl</button>
        </form>
        <div id="char-crawl-result" class="result"></div>
    </div>
</div>

{# ACP Post Sync #}
<div class="card" style="margin-top: 1.5rem;">
    <h3 class="card-title" style="margin-bottom: 0.5rem;">ACP Post Sync</h3>
    <p class="text-comment" style="font-size: 0.85rem; margin-bottom: 1rem;">
        Logs into JCink's Admin Control Panel and dumps the posts database for accurate post dates and activity tracking.
        This gives exact post counts and timestamps from the forum's SQL database instead of scraping HTML.
    </p>

    <div class="admin-grid" style="margin-bottom: 1rem;">
        {# Credentials #}
        <div style="flex: 1;">
            <h4 style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 0.5rem; color: var(--text-secondary);">ACP Credentials</h4>
            <form hx-post="/htmx/acp-credentials" hx-target="#acp-cred-result" hx-swap="innerHTML">
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <input type="text" name="acp_username" class="form-input"
                           placeholder="Admin username" value="{{ acp_username }}" required>
                    <input type="password" name="acp_password" class="form-input"
                           placeholder="Admin password" required>
                    <button type="submit" class="btn btn-purple">Save Credentials</button>
                </div>
            </form>
            <div id="acp-cred-result" class="result"></div>
        </div>

        {# Sync trigger #}
        <div style="flex: 1;">
            <h4 style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 0.5rem; color: var(--text-secondary);">Run Sync</h4>
            {% if acp_configured %}
            <p class="text-comment" style="font-size: 0.8rem; margin-bottom: 0.5rem;">
                Configured as: <span class="text-green">{{ acp_username }}</span>
                {% if acp_last_sync %}
                <br>Last sync: {{ acp_last_sync|format_time }}
                {% endif %}
            </p>
            <button class="btn btn-green"
                    hx-post="/htmx/acp-sync"
                    hx-target="#acp-sync-result"
                    hx-swap="innerHTML">Sync Posts from ACP</button>
            {% else %}
            <p class="text-comment" style="font-size: 0.85rem;">
                <span class="text-yellow">No credentials configured.</span>
                Enter your JCink admin username and password, then save.
            </p>
            <button class="btn btn-ghost" disabled>Sync Posts from ACP</button>
            {% endif %}
            <div id="acp-sync-result" class="result"></div>
        </div>
    </div>
</div>

{# Service info #}
<div class="card" style="margin-top: 1.5rem;">
    <h3 class="card-title" style="margin-bottom: 0.75rem;">Service Info</h3>
    <table class="fields-table">
        <tr>
            <td class="field-key">Status</td>
            <td class="field-value"><span class="text-green">Online</span></td>
        </tr>
        <tr>
            <td class="field-key">Last Crawl</td>
            <td class="field-value">{{ stats.last_crawl|format_time if stats.last_crawl else 'Never' }}</td>
        </tr>
        <tr>
            <td class="field-key">Characters Tracked</td>
            <td class="field-value">{{ stats.characters_tracked }}</td>
        </tr>
        <tr>
            <td class="field-key">Total Threads</td>
            <td class="field-value">{{ stats.total_threads }}</td>
        </tr>
        <tr>
            <td class="field-key">Total Quotes</td>
            <td class="field-value">{{ stats.total_quotes }}</td>
        </tr>
    </table>
</div>
{% endblock %}
