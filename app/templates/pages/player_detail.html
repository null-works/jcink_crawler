{% extends "base.html" %}
{% block title %}{{ player.player_name }} - The Watcher{% endblock %}
{% block content %}

{# Player header card #}
{% set ns = namespace(total_ongoing=0) %}
{% for c in player.characters %}{% set ns.total_ongoing = ns.total_ongoing + c.thread_counts.get('ongoing', 0) %}{% endfor %}
{% set total_ongoing = ns.total_ongoing %}
{% set al = total_ongoing|activity_level %}
<div class="card">
    <div class="char-header">
        <div class="char-info">
            <h1>{{ player.player_name }}</h1>
            <div class="group-name">Player</div>
            <span class="activity-badge {{ al.css }}">{{ al.label }}</span>

            <div class="char-counts">
                <div class="count-item">
                    <div class="num text-purple">{{ player.characters|length }}</div>
                    <div class="label">Characters</div>
                </div>
                <div class="count-item">
                    <div class="num text-green">{{ player.total_threads }}</div>
                    <div class="label">Threads</div>
                </div>
                <div class="count-item">
                    <div class="num text-cyan">{{ player.total_posts }}</div>
                    <div class="label">Total Posts</div>
                </div>
                <div class="count-item">
                    <div class="num text-orange">{{ player.total_monthly_posts }}</div>
                    <div class="label">This Period</div>
                </div>
                <div class="count-item">
                    <div class="num text-yellow">{{ player.total_awaiting }}</div>
                    <div class="label">Owed</div>
                </div>
                <div class="count-item">
                    <div class="num text-pink">{{ player.total_quotes }}</div>
                    <div class="label">Quotes</div>
                </div>
            </div>

            <div class="activity-bar-track" style="width: 200px;" title="{{ total_ongoing }} ongoing threads">
                <div class="activity-bar-fill {{ al.color }}" style="width: {{ [total_ongoing * 10, 100]|min }}%"></div>
            </div>
        </div>
    </div>
</div>

{# Month filter #}
<div class="card" style="padding: 1rem 1.5rem;">
    <form method="get" action="/player/{{ player.player_name }}" style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
        <label class="text-comment" style="font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em;">Activity Period</label>
        <input type="month" name="month" value="{{ month or '' }}" class="form-input" style="width: auto;">
        <button type="submit" class="btn btn-purple btn-sm">Filter</button>
        {% if month %}
        <a href="/player/{{ player.player_name }}" class="btn btn-ghost btn-sm">Reset</a>
        {% endif %}
        <span class="text-comment" style="font-size: 0.8rem;">
            Showing: {{ player.month_start }} to {{ player.month_end }}
        </span>
    </form>
</div>

{# Character roster #}
<div class="card">
    <h3 class="card-title" style="margin-bottom: 1rem;">Character Roster</h3>
    <div class="table-wrap">
    <table class="data-table">
        <thead>
            <tr>
                <th style="width: 48px;"></th>
                <th>Name</th>
                <th>Affiliation</th>
                <th>AC</th>
                <th>Posts</th>
                <th>Monthly</th>
                <th>Ongoing</th>
                <th class="hide-mobile">Comms</th>
                <th class="hide-mobile">Complete</th>
                <th>Owed</th>
                <th class="hide-mobile">Quotes</th>
            </tr>
        </thead>
        <tbody>
            {% for char in player.characters %}
            {% set char_ongoing = char.thread_counts.get('ongoing', 0) %}
            <tr class="clickable-row" onclick="window.location='/character/{{ char.id }}'">
                <td>
                    {% if char.avatar_url %}
                    <img src="{{ char.avatar_url }}" alt="" class="avatar-sm" loading="lazy">
                    {% else %}
                    <span class="avatar-placeholder">?</span>
                    {% endif %}
                </td>
                <td class="bold">{{ char.name }}</td>
                <td class="text-cyan">{{ char.affiliation or '—' }}</td>
                <td>
                    {% if not char.has_post_data %}
                    <span class="ac-badge ac-pending" title="Post data still loading — crawl in progress">PENDING</span>
                    {% elif char.monthly_posts >= 2 %}
                    <span class="ac-badge ac-safe" title="{{ char.monthly_posts }} posts this period">SAFE</span>
                    {% elif char.monthly_posts == 1 %}
                    <span class="ac-badge ac-warning" title="{{ char.monthly_posts }} post this period — needs 1 more">WARNING</span>
                    {% else %}
                    <span class="ac-badge ac-unsafe" title="0 posts this period — needs 2">DANGER</span>
                    {% endif %}
                </td>
                <td><span class="count-badge purple">{{ char.post_count }}</span></td>
                <td>
                    <span class="count-badge {% if char.monthly_posts >= 2 %}green{% elif char.monthly_posts == 1 %}yellow{% else %}red{% endif %}">
                        {{ char.monthly_posts }}
                    </span>
                </td>
                <td><span class="count-badge green">{{ char_ongoing }}</span></td>
                <td class="hide-mobile"><span class="count-badge cyan">{{ char.thread_counts.get('comms', 0) }}</span></td>
                <td class="hide-mobile"><span class="count-badge pink">{{ char.thread_counts.get('complete', 0) }}</span></td>
                <td>
                    {% if char.awaiting > 0 %}
                    <span class="count-badge yellow">{{ char.awaiting }}</span>
                    {% else %}
                    <span class="text-comment">0</span>
                    {% endif %}
                </td>
                <td class="hide-mobile">{{ char.quote_count }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
</div>

{# Awaiting reply threads #}
{% if player.awaiting_threads %}
<div class="card">
    <h3 class="card-title" style="margin-bottom: 1rem;">
        Owed <span class="count-badge yellow">{{ player.awaiting_threads|length }}</span>
    </h3>
    <div class="table-wrap">
    <table class="data-table">
        <thead>
            <tr>
                <th>Thread</th>
                <th>Character</th>
                <th>Last Poster</th>
            </tr>
        </thead>
        <tbody>
            {% for t in player.awaiting_threads %}
            <tr>
                <td class="truncate" style="max-width: 350px;">
                    <a href="{{ t.url }}" target="_blank" rel="noopener">{{ t.title }}</a>
                </td>
                <td>
                    <a href="/character/{{ t.char_id }}" class="text-purple">{{ t.char_name }}</a>
                </td>
                <td>
                    {% if t.last_poster_avatar %}
                    <img src="{{ t.last_poster_avatar }}" alt="" class="avatar-sm" style="vertical-align: middle; margin-right: 0.25rem;" loading="lazy">
                    {% endif %}
                    {{ t.last_poster_name or '—' }}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
</div>
{% endif %}

{% endblock %}
