{% from "components/pagination.html" import paginate %}
<table class="data-table">
    <thead>
        <tr>
            <th style="width: 48px;"></th>
            <th class="sortable {{ 'sort-asc' if sort == 'name' and dir == 'asc' }}{{ 'sort-desc' if sort == 'name' and dir == 'desc' }}"
                hx-get="/htmx/characters?sort=name&dir={{ 'desc' if sort == 'name' and dir == 'asc' else 'asc' }}"
                hx-target="#character-tbody" hx-include="[name='q'], [name='affiliation'], [name='group'], [name='player']">Name</th>
            <th class="sortable {{ 'sort-asc' if sort == 'affiliation' and dir == 'asc' }}{{ 'sort-desc' if sort == 'affiliation' and dir == 'desc' }}"
                hx-get="/htmx/characters?sort=affiliation&dir={{ 'desc' if sort == 'affiliation' and dir == 'asc' else 'asc' }}"
                hx-target="#character-tbody" hx-include="[name='q'], [name='affiliation'], [name='group'], [name='player']">Affiliation</th>
            <th class="sortable hide-mobile {{ 'sort-asc' if sort == 'player' and dir == 'asc' }}{{ 'sort-desc' if sort == 'player' and dir == 'desc' }}"
                hx-get="/htmx/characters?sort=player&dir={{ 'desc' if sort == 'player' and dir == 'asc' else 'asc' }}"
                hx-target="#character-tbody" hx-include="[name='q'], [name='affiliation'], [name='group'], [name='player']">Player</th>
            <th>Ongoing</th>
            <th>Comms</th>
            <th class="hide-mobile">Complete</th>
            <th class="hide-mobile">Incomplete</th>
            <th class="sortable {{ 'sort-asc' if sort == 'total_threads' and dir == 'asc' }}{{ 'sort-desc' if sort == 'total_threads' and dir == 'desc' }}"
                hx-get="/htmx/characters?sort=total_threads&dir={{ 'desc' if sort == 'total_threads' and dir == 'asc' else 'asc' }}"
                hx-target="#character-tbody" hx-include="[name='q'], [name='affiliation'], [name='group'], [name='player']">Total</th>
            <th class="sortable hide-mobile {{ 'sort-asc' if sort == 'last_thread_crawl' and dir == 'asc' }}{{ 'sort-desc' if sort == 'last_thread_crawl' and dir == 'desc' }}"
                hx-get="/htmx/characters?sort=last_thread_crawl&dir={{ 'desc' if sort == 'last_thread_crawl' and dir == 'asc' else 'asc' }}"
                hx-target="#character-tbody" hx-include="[name='q'], [name='affiliation'], [name='group'], [name='player']">Last Crawled</th>
        </tr>
    </thead>
    <tbody>
{% for char in characters %}
<tr class="clickable-row" onclick="window.location='/character/{{ char.id }}'">
    <td>
        {% if char.avatar_url %}
        <img src="{{ char.avatar_url }}" alt="" class="avatar-sm" loading="lazy">
        {% else %}
        <span class="avatar-placeholder">?</span>
        {% endif %}
    </td>
    <td class="bold">{{ char.name }}</td>
    <td class="text-cyan">{{ char.affiliation or '—' }}</td>
    <td class="hide-mobile">
        {% if char.player %}
        <a href="/player/{{ char.player|urlencode }}" class="text-purple" onclick="event.stopPropagation()">{{ char.player }}</a>
        {% else %}
        <span class="text-comment">—</span>
        {% endif %}
    </td>
    <td><span class="count-badge green">{{ char.thread_counts.get('ongoing', 0) }}</span></td>
    <td><span class="count-badge cyan">{{ char.thread_counts.get('comms', 0) }}</span></td>
    <td><span class="count-badge pink">{{ char.thread_counts.get('complete', 0) }}</span></td>
    <td><span class="count-badge yellow">{{ char.thread_counts.get('incomplete', 0) }}</span></td>
    <td class="bold">{{ char.thread_counts.get('total', 0) }}</td>
    <td class="text-comment">{{ char.last_thread_crawl|format_time }}</td>
</tr>
{% endfor %}
{% if not characters %}
<tr><td colspan="10" class="empty-state">No characters found</td></tr>
{% endif %}
    </tbody>
</table>
{% set extra = "" %}
{% if q %} {% set extra = extra ~ "&q=" ~ q %} {% endif %}
{% if affiliation %} {% set extra = extra ~ "&affiliation=" ~ affiliation %} {% endif %}
{% if group %} {% set extra = extra ~ "&group=" ~ group %} {% endif %}
{% if player %} {% set extra = extra ~ "&player=" ~ player %} {% endif %}
{% if sort %} {% set extra = extra ~ "&sort=" ~ sort %} {% endif %}
{% if dir %} {% set extra = extra ~ "&dir=" ~ dir %} {% endif %}
{{ paginate(total, page, per_page, "character-tbody", "/htmx/characters", extra) }}
